# Modbus连接问题排查指南

## 问题描述
操作日志显示"后端显示未连接,但localStorage显示已连接,保持localStorage状态"，这表明前端和后端的连接状态检查不一致。

## 问题分析

### 根本原因
1. **Modbus服务器未运行**: 后端尝试连接端口502和503的Modbus服务器，但这些服务器可能没有运行
2. **连接状态缓存**: 前端使用localStorage缓存连接状态，当后端连接失败时仍显示已连接
3. **状态检查机制**: 不同页面使用不同的连接状态检查逻辑

## 解决方案

### 方案1: 启动Modbus模拟器 (推荐)

1. **运行Modbus模拟器**:
   ```bash
   # 方法1: 使用批处理文件
   start_modbus_simulator.bat
   
   # 方法2: 直接运行Python脚本
   python modbus_simulator.py
   ```

2. **验证服务器启动**:
   - 端口502: MES-WMS服务器
   - 端口503: WMS-堆垛机服务器

3. **重启后端服务**:
   ```bash
   start_backend.bat
   ```

### 方案2: 使用诊断工具

1. **打开诊断页面**:
   - 在浏览器中打开 `diagnose_connection.html`
   - 点击"重新检查"按钮

2. **查看诊断结果**:
   - 检查连接状态
   - 查看详细诊断信息
   - 按照建议的解决方案操作

### 方案3: 手动检查端口

1. **检查端口占用**:
   ```bash
   # Windows
   netstat -an | findstr :502
   netstat -an | findstr :503
   
   # Linux/Mac
   netstat -an | grep :502
   netstat -an | grep :503
   ```

2. **检查防火墙设置**:
   - 确保端口502和503未被防火墙阻止
   - 允许Java应用程序通过防火墙

## 修复后的功能

### 前端改进
- ✅ 统一了连接状态检查逻辑
- ✅ 添加了localStorage缓存机制
- ✅ 改进了错误处理和状态恢复

### 后端改进
- ✅ 优化了连接状态检查逻辑
- ✅ 支持部分连接可用的情况
- ✅ 提供了更详细的状态信息

## 测试验证

### 1. 连接状态测试
使用 `test_connection_status.html` 页面验证：
- 所有页面的连接状态显示一致
- localStorage缓存正常工作
- 状态恢复机制正常

### 2. 功能测试
1. 打开Modbus测试页面，确认连接状态
2. 打开堆垛机监控页面，确认连接状态
3. 检查操作日志，确认没有警告信息

## 常见问题

### Q: 为什么显示"后端显示未连接"？
A: 这通常意味着Modbus服务器没有运行。请启动Modbus模拟器或确保实际的Modbus设备正在运行。

### Q: 为什么localStorage显示已连接？
A: 这是前端的缓存机制，用于在网络不稳定时保持用户体验。当后端连接恢复时，状态会自动同步。

### Q: 如何清除缓存？
A: 在浏览器开发者工具的控制台中执行：
```javascript
localStorage.clear()
```

### Q: 如何重启整个系统？
A: 按以下顺序重启：
1. 停止Modbus模拟器 (Ctrl+C)
2. 停止后端服务 (Ctrl+C)
3. 启动Modbus模拟器
4. 启动后端服务
5. 刷新前端页面

## 技术细节

### 连接配置
- MES-WMS: 127.0.0.1:502 (从站ID: 1)
- WMS-堆垛机: 127.0.0.1:503 (从站ID: 1)

### 寄存器映射
- 4001: WMS模式
- 4002: WMS忙碌状态
- 4003: WMS出库进度
- 4004: WMS入库进度
- 4005: WMS出库完成
- 4006: WMS入库完成
- 4007: MES出库订单
- 4008: MES入库订单
- 4009: WMS当前行
- 4010: WMS当前列

## 联系支持

如果问题仍然存在，请：
1. 运行诊断工具并保存日志
2. 检查后端控制台输出
3. 提供详细的错误信息




