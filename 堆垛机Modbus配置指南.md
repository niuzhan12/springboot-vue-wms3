# 堆垛机Modbus Slave配置指南

## 问题说明
当前WMS无法与堆垛机通信，因为Modbus Slave中没有配置堆垛机寄存器（4001-4009）。

## 解决方案
在Modbus Slave中配置以下寄存器：

### 堆垛机Modbus寄存器配置

| 寄存器地址 | 功能 | 初始值 | 说明 |
|-----------|------|--------|------|
| 4001 | 堆垛机状态 | 0 | 0:空闲, 1:忙, 2:故障 |
| 4002 | 堆垛机当前操作 | 0 | 0:无, 1:入库, 2:出库 |
| 4003 | 堆垛机目标行 | 0 | 目标行号 |
| 4004 | 堆垛机目标列 | 0 | 目标列号 |
| 4005 | 堆垛机当前行 | 0 | 当前行号 |
| 4006 | 堆垛机当前列 | 0 | 当前列号 |
| 4007 | 堆垛机操作进度 | 0 | 0-100% |
| 4008 | 堆垛机操作完成 | 0 | 0:未完成, 1:完成 |
| 4009 | 堆垛机故障代码 | 0 | 0:无故障 |

## 配置步骤

### 1. 在Modbus Slave中添加寄存器
1. 打开Modbus Slave软件
2. 在寄存器列表中添加以下寄存器：
   - 4001: 堆垛机状态
   - 4002: 堆垛机当前操作
   - 4003: 堆垛机目标行
   - 4004: 堆垛机目标列
   - 4005: 堆垛机当前行
   - 4006: 堆垛机当前列
   - 4007: 堆垛机操作进度
   - 4008: 堆垛机操作完成
   - 4009: 堆垛机故障代码

### 2. 设置寄存器属性
- **数据类型**: 16位无符号整数 (Unsigned 16-bit)
- **初始值**: 全部设置为0
- **读写权限**: 可读写

### 3. 测试配置
配置完成后，WMS应该能够：
1. 读取堆垛机状态
2. 发送操作指令到堆垛机
3. 监控堆垛机进度
4. 接收堆垛机完成信号

## 工作流程

### 入库流程
1. MES发送入库订单 (4008=1)
2. WMS检测到订单，设置WMS忙碌状态
3. WMS发送入库指令到堆垛机：
   - 4002=1 (入库操作)
   - 4003=目标行
   - 4004=目标列
   - 4001=1 (堆垛机忙碌)
4. 堆垛机执行操作，更新进度：
   - 4007=进度百分比
   - 4005=当前行
   - 4006=当前列
5. 堆垛机完成操作：
   - 4008=1 (操作完成)
   - 4001=0 (堆垛机空闲)
6. WMS检测到完成信号，更新库位数据库
7. WMS通知MES完成

### 出库流程
1. MES发送出库订单 (4007=1)
2. WMS检测到订单，设置WMS忙碌状态
3. WMS发送出库指令到堆垛机：
   - 4002=2 (出库操作)
   - 4003=目标行
   - 4004=目标列
   - 4001=1 (堆垛机忙碌)
4. 堆垛机执行操作，更新进度
5. 堆垛机完成操作，通知WMS
6. WMS更新库位数据库，通知MES完成

## 注意事项
1. 确保Modbus Slave运行在127.0.0.1:502端口
2. 确保Slave ID设置为1
3. 寄存器地址必须是4001-4009，不能更改
4. 数据类型必须是16位无符号整数
5. 配置完成后重启WMS服务

## 故障排除
如果仍然出现"Illegal Data Address"错误：
1. 检查寄存器地址是否正确
2. 检查数据类型是否正确
3. 检查Modbus Slave是否正在运行
4. 检查端口和Slave ID是否正确
